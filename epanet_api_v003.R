#...............................................................................
# 1. - Initialize Session #### 
#...............................................................................

cat("\014")
rm(list=ls()) 

# Initialize params

params <- list(net_works = "prv_01", 
               inlet_valves = c("PRV_001"),
               time_step = "hour")

# Installs libraries 

library(tidyverse)
library(epanetReader)
library(epanet2toolkit)
library(ggfortify)
library(ggthemes)

library(zoo)
library(scales)
library(lubridate)


# initialize files paths and files

dir_work   <-  getwd()
dir_report <-  file.path(dir_work,"reports") 
dir_data   <-  file.path(dir_work,"data")  
dir_bin    <-  file.path(dir_work,"reports")
dir_func   <-  file.path(dir_work,"func")

# The input processor module receives a description of the network 
# being simulated from an external input file (*.INP)

file_inp     <- file.path(dir_data,   paste0(params$net_work,".inp"))
file_report  <- file.path(dir_report, paste0(params$net_work,".rpt"))
file_bin     <- file.path(dir_report, paste0(params$net_work,".bin"))

file_func     <- file.path(dir_func,   "epanet_api_functions.R")

# Load Functions Standard

source(file_func)

# Read network information from an *.inp

net_input_01  <- read.inp(file_inp)

#...............................................................................
# Plot Network
#...............................................................................

# plot(net_input_01)

#...............................................................................
# Plot Consumtion/Demand Patterns
#...............................................................................


idx <- seq(ymd_hm("2020-1-1 1:00"), 
           ymd_hm("2020-1-1 24:00"), 
           by = params$time_step)

patterns <- as.tibble(net_input_01$Patterns) %>% as.zoo(idx)

plot_ts_curves(patterns,
               m_title ="Patterns for the Flow Factor",  
               y_lab = "Flow Factor")


#...............................................................................
# 2. Running a Full Simulation                                             ####
#    The function ENepanet() runs a full simulation and 
#    writes the results to a file. 
#
# REMEBER !!!
# Add the line 'Nodes All' to the [REPORT] section of the .inp file.
# Add the line 'Links All' to the [REPORT] section of the .inp file.
#...............................................................................

ENepanet(file_inp, file_report)

#...............................................................................
# The .rpt file generated by Epanet may be read into R using read.rpt(). 
# The simulation is summarized over junctions, tanks and pipes.
#...............................................................................

# For the Valve GPV001 in STATUS OPEN
# [STATUS]
# ;ID              	Status/Setting
# GPV001          	Open

net_report_01 <- read.rpt(file_report) 

inlet_flow <- as.tibble(subset(net_report_01$linkResults, 
                               ID == params$inlet_valves[1])) %>%
              select(Flow) %>%
              as.zoo(idx)



plot_ts_curves(inlet_flow,
               m_title ="Inlet Flow (l/s)",
               y_lab = "Flow (l/s)")

# inhabitants = aprox. 10,000
# consum about 125 l/hab/day
# round(sum(inlet_flow)*((60*60)/125.0),0)


#...............................................................................
# ACTUAL STATUS MARKER !!!!!!!
#...............................................................................
