#...............................................................................
# 1. - Initialize Session #### 
#...............................................................................

cat("\014")
rm(list=ls()) 

# Initialize params

params <- list(net_works = c("prv_01"))

# Installs libraries 

library(tidyverse)
library(epanetReader)
library(epanet2toolkit)
library(data.table)
library(zoo)

# initialize files paths and files

dir_work   <-  getwd()
dir_report <-  file.path(dir_work,"reports") 
dir_data   <-  file.path(dir_work,"data")  
dir_bin    <-  file.path(dir_work,"reports")

# The input processor module receives a description of the network 
# being simulated from an external input file (*.INP)
file_inp     <- file.path(dir_data,   paste0(params$net_work,".inp"))
file_report  <- file.path(dir_report, paste0(params$net_work,".rpt"))
file_bin     <- file.path(dir_report, paste0(params$net_work,".bin"))

# Read network information from an *.inp

net_input_01  <- read.inp(file_inp)

# Types of Objects (from EPANET Manual)
# EPANET contains both physical objects that can appear on the network map, and
# non-physical objects that encompass design and operational information. 
# after reading the file * .inp EPANET-Reader generates a List. 
#
# These List objects can be classified as followed:
# 
# 1.- NODES:
#     - $Junctions
#     - $Reservoirs
#     - $Tanks
# 2.- LINKS:
#     - $Pipes
#     - $Pumps
#     - $Valves
# 3.- MAP LABLES
# 4.- TIME PATTERNS:
# 5.- CURVES:
# 6.- CONTROLS:
#     - $Controls
#     - $Rules


# Plot Network

plot(net_input_01)

# Plot Patterns for:
# - three different periods of the year have been identified 
#   named: “spring_summer”, “fall_winter” and “summer_break”;
# - two different types of day for each time period exist 
#   named: wd (working-days) and hw (holidays-weekends). 

# Biblio:
# Identifying Typical Urban Water Demand Patterns for a Reliable 
# Short-Term Forecasting – The Icewater Project Approach;
# A. Candelieri, F. Archetti
# [https://www.sciencedirect.com/science/article/pii/S1877705814023339]


idx <- seq(ymd_hm("2018-1-1 1:00"), ymd_hm("2018-1-1 24:00"), by = "hour")

spring_summer <- tibble(wd = net_input_01$Patterns$wd_spring_summer,
                        hw = net_input_01$Patterns$hw_spring_summer) %>%
                 as.zoo(idx)

summer_break <- tibble(wd = net_input_01$Patterns$wd_summer_break,
                       hw = net_input_01$Patterns$hw_summer_break) %>%
                as.zoo(idx)
  

fall_winter  <- tibble(wd = net_input_01$Patterns$wd_fall_winter,
                       hw = net_input_01$Patterns$hw_fall_winter)%>%
                as.zoo(idx)

# Retrieve summary information about the network.
names(net_input_01)

summary(net_input_01)
summary(net_input_01$Junctions)
summary(net_input_01$Emitters)

net_input_01$Patterns

str(net_input_01$Patterns)
length(net_input_01$Patterns$PT0001)

# A basic network plot 
# plot(net_input_01$Patterns$PT0001)
# plot(net_input_01)

#...............................................................................
# 2. Running a Full Simulation                                             ####
#    The function ENepanet() runs a full simulation and 
#    writes the results to a file. 
#
# REMEBER !!!
# Add the line 'Nodes All' to the [REPORT] section of the .inp file.
# Add the line 'Links All' to the [REPORT] section of the .inp file.
#...............................................................................

ENepanet(file_inp, file_report)

# The .rpt file generated by Epanet may be read into R using read.rpt(). 
# The simulation is summarized over junctions, tanks and pipes.

net_report_01 <- read.rpt(file_report) 
summary(net_report_01)

# Results for a chosen time period can be retrieved using the subset function.



t000 <- subset(net_report_01$nodeResults, 
               Timestamp == "0:15:00")



#unique time stamps
ts   <- unique(net_report_01$nodeResults$Timestamp)
imax <- length(ts)

# generate animation of plots at each time step
saveHTML(
  for( i in 1:imax){
    plot(net_report_01, net_input_01, Timestep = ts[i]) 
  }
)
